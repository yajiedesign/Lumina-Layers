# Lumina-Layers

An experimental FDM engine exploring **layered optical color mixing**.  
Starting with CMYK pixel art, evolving into a universal multi-material photo processor.

**[ğŸ“– ä¸­æ–‡æ–‡æ¡£ / Chinese Version](README_CN.md)**

---

## ğŸŒŸ Inspiration & Origins

This project is inspired by the pioneering work in multi-color 3D printing:

- **HueForge** - The groundbreaking tool that introduced optical color mixing to the FDM community, demonstrating how transparent filament layers can create rich colors through additive light transmission.
- **AutoForge** - Automated color matching workflows that made multi-material color printing accessible.
- **CMYK Printing Theory** - Traditional subtractive color model adapted for 3D printing through layer-by-layer transmission.

Lumina-Layers builds upon these foundations by introducing a **closed-loop calibration system** to address the real-world variance in filament properties, printer hardware, and environmental conditions.

---

## ğŸ›‘ NON-COMMERCIAL USE ONLY

This software and any models generated by it are licensed under **CC BY-NC-SA 4.0**.

- âŒ Do **NOT** sell the generated STL/3MF files.
- âŒ Do **NOT** sell physical prints generated by this tool.
- âŒ Do **NOT** package this tool into a paid service.

For commercial licensing inquiries, please contact the author.

---

## ğŸ“– Overview

**Lumina-Layers** bridges the gap between digital pixels and physical filaments.

Traditional multi-color relief tools rely on theoretical "Transmission Distance" (TD) values, which often fail due to filament batch variance, nozzle temperature, or slicer logic. Lumina-Layers uses a **Closed-Loop Calibration System**. By scanning a physically printed color matrix, it builds a "Ground Truth" Look-Up Table (LUT) specific to your printer hardware, ensuring accurate color reproduction for pixel art and relief models.

---

## ğŸ”„ The Closed-Loop Workflow


### ğŸ“ Module 1: Calibration Generator
Generates a precision calibration board to physically test filament mixing.

- **1024-Color Matrix**: Full permutation of 4 base filaments across 5 layers (0.4mm total).
- **Dual Color Modes**: Supports both **CMYW** (Cyan/Magenta/Yellow/White) and **RYBW** (Red/Yellow/Blue/White).
- **Face-Down Optimization**: Prints the viewing surface directly on the build plate for a smooth finish.
- **Solid Backing**: Automatically generates a 1.6mm opaque backing to ensure color consistency and structural rigidity.
- **Anti-Overlap Geometry**: Applies 0.02mm micro-shrinkage to voxels to prevent slicer line-width conflicts.

### ğŸ¨ Module 2: Color Extractor
Digitizes the physical reality of your printer.

- **Computer Vision**: Auto-aligns the grid using perspective warp and lens distortion correction.
- **Mode-Aware Alignment**: Corner markers follow the correct color sequence based on your selected mode (CMYW vs RYBW).
- **Digital Twin**: Extracts RGB values from the print and generates a `.npy` LUT file.
- **Human-in-the-Loop**: Interactive probe tools allow you to manually verify and correct specific color block readings (e.g., removing glare/shadows).

### ğŸ’ Module 3: Image Converter
Converts images into printable 3D models using the calibrated data.

- **KD-Tree Color Matching**: Maps image pixels to the actual printable colors found in your LUT.
- **Live 3D Preview**: Interactive WebGL preview with true matched colors - rotate, zoom, and inspect before printing.
- **Keychain Loop Generator**: Automatically adds functional hanging loops with:
  - Smart color detection (matches nearby model colors)
  - Customizable dimensions (width, length, hole diameter)
  - Rectangle base + semicircle top + hollow hole geometry
  - 2D preview shows loop placement
- **Structure Options**: Double-sided (keychain) or Single-sided (relief) modes.
- **Smart Background Removal**: Automatic transparency detection with adjustable tolerance.
- **Correct 3MF Naming**: Objects are named by color (e.g., "Cyan", "Magenta") instead of "geometry_0" for easy slicer identification.

---

## âœ¨ What's New in v1.3

| Feature | Description |
|---------|-------------|
| ğŸ”— **Keychain Loop** | Add functional hanging loops with auto-color detection |
| ğŸ¨ **Loop Shape** | Rectangle bottom + semicircle top + hollow hole |
| ğŸ‘ï¸ **2D Preview** | Click to place loop; real-time preview with rotation |
| ğŸ¯ **Smart Color** | Automatically matches loop color to nearby model pixels |

### Previous Updates (v1.2)
| Feature | Description |
|---------|-------------|
| ğŸ”§ **Fixed 3MF Naming** | Slicer now shows correct color names (White, Cyan, Magenta...) |
| ğŸ¨ **Dual Color Modes** | Full support for both CMYW and RYBW color systems |
| ğŸ® **Live 3D Preview** | Interactive preview with actual LUT-matched colors |
| ğŸŒ **Bilingual UI** | Chinese/English labels throughout the interface |
| ğŸ“ **Optimized Gap** | Default gap changed to 0.82mm for standard line widths |

---

## ğŸ—ºï¸ Development Roadmap

### Phase 1: The Foundation âœ… **COMPLETE**
> Target: Pixel Art & Simple Graphics.

- âœ… Fixed CMYW/RYBW mixing
- âœ… Integer-based "Slab" geometry
- âœ… Solid Backing generation
- âœ… Closed-loop calibration system
- âœ… Live 3D preview with true colors
- âœ… Keychain loop generator

### Phase 2: Manga Mode (Monochrome) ğŸš§ **IN PROGRESS**
> Target: Manga panels, Ink drawings, High-contrast illustrations.

- Logic: Black & White layering using thickness-based grayscale (Lithophane logic).
- Tech: Simulating screen tones (Ben-Day dots).

### Phase 3: Full-Color Photo Engine
> Target: Photographs, Anime illustrations.

- Logic: Dynamic Palette Support (4/6/8 colors).
- Tech:
  - Advanced Dithering algorithms (Floyd-Steinberg/Atkinson) to simulate gradients.
  - LAB Color Space integration for better perceptual matching.

### Phase 4: Extended Color Modes
> Target: Professional multi-material printing.

- 6-color extended mode
- 8-color professional mode
- Perler bead mode

---

## ğŸ› ï¸ Installation

**Clone the repository**
```bash
git clone https://github.com/MOVIBALE/Lumina-Layers.git
cd Lumina-Layers
```

**Install dependencies**
```bash
pip install -r requirements.txt
```

---

## ğŸš€ Usage Guide

### Quick Start
```bash
python main.py
```
This launches the web interface with all three modules in tabs.

---

### Step 1: Generate Calibration Board

1. Open the **ğŸ“ Calibration** tab
2. Select your color mode:
   - **RYBW** (Red/Yellow/Blue/White) - Traditional primaries
   - **CMYW** (Cyan/Magenta/Yellow/White) - Print colors, wider gamut
3. Adjust block size (default: 5mm) and gap (default: 0.82mm)
4. Click **Generate** and download the `.3mf` file

**Print Settings:**
- Layer height: 0.08mm (color layers), backing can use 0.2mm
- Filament slots must match your selected mode

| Mode | Slot 1 | Slot 2 | Slot 3 | Slot 4 |
|------|--------|--------|--------|--------|
| RYBW | White | Red | Yellow | Blue |
| CMYW | White | Cyan | Magenta | Yellow |

---

### Step 2: Extract Colors

1. Print the calibration board and photograph it (face-up, even lighting)
2. Open the **ğŸ¨ Color Extractor** tab
3. **Select the same color mode** as your calibration board
4. Upload your photo
5. Click the four corner blocks in order:

| Mode | Corner 1 (TL) | Corner 2 (TR) | Corner 3 (BR) | Corner 4 (BL) |
|------|---------------|---------------|---------------|---------------|
| RYBW | â¬œ White | ğŸŸ¥ Red | ğŸŸ¦ Blue | ğŸŸ¨ Yellow |
| CMYW | â¬œ White | ğŸ”µ Cyan | ğŸŸ£ Magenta | ğŸŸ¨ Yellow |

6. Adjust correction sliders if needed (white balance, vignette, distortion)
7. Click **Extract** and download `my_printer_lut.npy`

---

### Step 3: Convert Image

1. Open the **ğŸ’ Image Converter** tab
2. Upload your `.npy` LUT file
3. Upload your image (pixel art works best)
4. **Select the same color mode** as your LUT
5. Click **ğŸ‘ï¸ Generate Preview** to see the result
6. **(Optional) Add Keychain Loop:**
   - Click on the 2D preview where you want the loop attached
   - Enable "å¯ç”¨æŒ‚å­”" checkbox
   - Adjust loop width, length, and hole diameter
   - The loop color is automatically detected from nearby pixels
7. Choose structure type:
   - **Double-sided** - For keychains (image on both sides)
   - **Single-sided** - For relief/lithophane style
8. Click **ğŸš€ Generate 3MF**
9. Preview in the interactive 3D viewer
10. Download the `.3mf` file

---

## ğŸ§± Technical Stack

| Component | Technology |
|-----------|------------|
| Core Logic | Python (NumPy for voxel manipulation) |
| Geometry Engine | Trimesh (Mesh generation & Export) |
| UI Framework | Gradio 4.0+ |
| Vision Stack | OpenCV (Perspective & Color Extraction) |
| Color Matching | SciPy KDTree |
| 3D Preview | Gradio Model3D (GLB format) |

---

## ğŸ”¬ How It Works

### Optical Color Theory
Lumina-Layers uses the **Beer-Lambert Law** for light transmission through layered media:

\[I = I_0 \cdot e^{-\alpha \cdot d}\]

Where:
- \(I\) = transmitted light intensity
- \(I_0\) = incident light intensity
- \(\alpha\) = absorption coefficient (material-specific)
- \(d\) = layer thickness

By stacking 5 layers of different colored filaments (each 0.08mm), we create a total transmission distance of 0.4mm, allowing complex color mixing through subtractive absorption.

### Why Calibration Matters
Theoretical TD values assume:
- Perfectly consistent filament dye concentration
- Identical nozzle temperatures across all materials
- Uniform layer adhesion

In reality, these vary significantly between:
- Different filament brands/batches
- Printer models and nozzle designs
- Environmental humidity and temperature

**The LUT-based approach solves this** by measuring actual printed colors and matching them via nearest-neighbor search in RGB space.

---

## ğŸ“„ License

This project is licensed under the **Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)**.

- âœ… **Attribution**: You must give appropriate credit.
- âŒ **NonCommercial**: You may not use this for commercial purposes.
- ğŸ”„ **ShareAlike**: If you modify it, you must distribute it under the same license.

---

## ğŸ™ Acknowledgments

Special thanks to:
- **HueForge** for pioneering optical color mixing in FDM printing
- **AutoForge** for democratizing multi-color workflows
- The 3D printing community for continuous innovation

---

<div align="center">

Made with â¤ï¸ by [MIN]

**â­ Star this repo if you find it useful!**

</div>
